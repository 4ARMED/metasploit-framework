<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Rex::Exploitation::JSObfu
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../';
  framesUrl = "../../frames.html#!Rex/Exploitation/JSObfu.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../_index.html">Index (J)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Rex.html" title="Rex (module)">Rex</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Exploitation.html" title="Rex::Exploitation (module)">Exploitation</a></span></span>
     &raquo; 
    <span class="title">JSObfu</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Rex::Exploitation::JSObfu
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Rex::Exploitation::JSObfu</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/rex/exploitation/jsobfu.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Obfuscate JavaScript by randomizing as much as possible and removing
easily-signaturable string constants.</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_js'>js</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>Rex</span><span class='op'>::</span><span class='const'>Exploitation</span><span class='op'>::</span><span class='const'>JSObfu</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>%Q|</span><span class='tstring_content'>
  var a = &quot;0\\612\\063\\x34\\x35\\x36\\x37\\x38\\u0039&quot;;
  var b = { foo : &quot;foo&quot;, bar : &quot;bar&quot; }
  alert(a);
  alert(b.foo);
</span><span class='tstring_end'>|</span></span>
<span class='id identifier rubyid_js'>js</span><span class='period'>.</span><span class='id identifier rubyid_obfuscate'>obfuscate</span>
<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_js'>js</span></code></pre>

<p>Example Output:</p>

<pre class="code ruby"><code class="ruby">var VwxvESbCgv = String.fromCharCode(0x30,0x31,062,063,064,53,0x36,067,070,0x39);
var ToWZPn = {
  &quot;\146\157\x6f&quot;: (function () { var yDyv=&quot;o&quot;,YnCL=&quot;o&quot;,Qcsa=&quot;f&quot;; return Qcsa+YnCL+yDyv })(),
  &quot;\142ar&quot;: String.fromCharCode(0142,97,0162)
};
alert(VwxvESbCgv);
alert(ToWZPn.foo);</code></pre>

<p>NOTE: Variables MUST be declared with a &#39;var&#39; statement BEFORE
first use (or not at all) for this to generate correct code!  If variables
are not declared they will not be randomized but the generated code will be
correct.</p>

<p>Bad Example Javascript:</p>

<pre class="code ruby"><code class="ruby">a = &quot;asdf&quot;; // this variable hasn&#39;t been declared and will not be randomized
var a;
alert(a); // real js engines will alert &quot;asdf&quot; here</code></pre>

<p>Bad Example Obfuscated:</p>

<pre class="code ruby"><code class="ruby">a = (function () { var hpHu=&quot;f&quot;,oyTm=&quot;asd&quot;; return oyTm+hpHu })();
var zSrnHpEfJZtg;
alert(zSrnHpEfJZtg);</code></pre>

<p>Notice that the first usage of <code>a</code> (before it was declared) is
not randomized.  Thus, the obfuscated version will alert
&#39;undefined&#39; instead of “asdf”.</p>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="RESERVED_KEYWORDS-constant" class="">RESERVED_KEYWORDS =
          <div class="docstring">
  <div class="discussion">
    
<p>these keywords should never be used as a random var name source: <a
href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Reserved_Words">developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Reserved_Words</a></p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='qwords_beg'>%w(
</span><span class='tstring_content'>break</span><span class='words_sep'> </span><span class='tstring_content'>case</span><span class='words_sep'> </span><span class='tstring_content'>catch</span><span class='words_sep'> </span><span class='tstring_content'>continue</span><span class='words_sep'> </span><span class='tstring_content'>debugger</span><span class='words_sep'> </span><span class='tstring_content'>default</span><span class='words_sep'> </span><span class='tstring_content'>delete</span><span class='words_sep'> </span><span class='tstring_content'>do</span><span class='words_sep'> </span><span class='tstring_content'>else</span><span class='words_sep'> </span><span class='tstring_content'>finally</span><span class='words_sep'>
</span><span class='tstring_content'>for</span><span class='words_sep'> </span><span class='tstring_content'>function</span><span class='words_sep'> </span><span class='tstring_content'>if</span><span class='words_sep'> </span><span class='tstring_content'>in</span><span class='words_sep'> </span><span class='tstring_content'>instanceof</span><span class='words_sep'> </span><span class='tstring_content'>new</span><span class='words_sep'> </span><span class='tstring_content'>return</span><span class='words_sep'> </span><span class='tstring_content'>switch</span><span class='words_sep'> </span><span class='tstring_content'>this</span><span class='words_sep'> </span><span class='tstring_content'>throw</span><span class='words_sep'> </span><span class='tstring_content'>try</span><span class='words_sep'>
</span><span class='tstring_content'>typeof</span><span class='words_sep'> </span><span class='tstring_content'>var</span><span class='words_sep'> </span><span class='tstring_content'>void</span><span class='words_sep'> </span><span class='tstring_content'>while</span><span class='words_sep'> </span><span class='tstring_content'>with</span><span class='words_sep'> </span><span class='tstring_content'>class</span><span class='words_sep'> </span><span class='tstring_content'>enum</span><span class='words_sep'> </span><span class='tstring_content'>export</span><span class='words_sep'> </span><span class='tstring_content'>extends</span><span class='words_sep'> </span><span class='tstring_content'>import</span><span class='words_sep'> </span><span class='tstring_content'>super</span><span class='words_sep'>
</span><span class='tstring_content'>implements</span><span class='words_sep'> </span><span class='tstring_content'>interface</span><span class='words_sep'> </span><span class='tstring_content'>let</span><span class='words_sep'> </span><span class='tstring_content'>package</span><span class='words_sep'> </span><span class='tstring_content'>private</span><span class='words_sep'> </span><span class='tstring_content'>protected</span><span class='words_sep'> </span><span class='tstring_content'>public</span><span class='words_sep'> </span><span class='tstring_content'>static</span><span class='words_sep'> </span><span class='tstring_end'>yield</span></span></pre></dd>
      
    </dl>
  




  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#ast-instance_method" title="#ast (instance method)">- (Object) <strong>ast</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Abstract Syntax Tree generated by RKelly::Parser#parse.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#%3C%3C-instance_method" title="#&lt;&lt; (instance method)">- (Object) <strong>&lt;&lt;</strong>(str) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Add <code>str</code> to the un-obfuscated code.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#escape_length-instance_method" title="#escape_length (instance method)">- (Object) <strong>escape_length</strong>(str) </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Stolen from obfuscatejs.rb.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (JSObfu) <strong>initialize</strong>(code) </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Saves <code>code</code> for later obfuscation with #obfuscate.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#obfuscate-instance_method" title="#obfuscate (instance method)">- (Object) <strong>obfuscate</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Parse and obfuscate.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#obfuscate_r-instance_method" title="#obfuscate_r (instance method)">- (Object) <strong>obfuscate_r</strong>(ast) </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Recursive method to obfuscate the given <code>ast</code>.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#parse-instance_method" title="#parse (instance method)">- (Object) <strong>parse</strong> </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generate an Abstract Syntax Tree (#ast) for later obfuscation.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#rand_base-instance_method" title="#rand_base (instance method)">- (Object) <strong>rand_base</strong>(num) </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Convert a number to a random base (decimal, octal, or hexedecimal).</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#random_string-instance_method" title="#random_string (instance method)">- (String) <strong>random_string</strong> </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A random string.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#random_var_name-instance_method" title="#random_var_name (instance method)">- (String) <strong>random_var_name</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A unique random var name that is not a reserved keyword.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#safe_split-instance_method" title="#safe_split (instance method)">- (Object) <strong>safe_split</strong>(str, quote) </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Split a javascript string, <code>str</code>, without breaking escape
sequences.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sym-instance_method" title="#sym (instance method)">- (Object) <strong>sym</strong>(lookup) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return the obfuscated name of a symbol.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_s-instance_method" title="#to_s (instance method)">- (Object) <strong>to_s</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return the (possibly obfuscated) code as a string.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#transform_number-instance_method" title="#transform_number (instance method)">- (Object) <strong>transform_number</strong>(num) </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return a mathematical expression that will evaluate to the given number
<code>num</code>.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#transform_string-instance_method" title="#transform_string (instance method)">- (Object) <strong>transform_string</strong>(str) </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Convert a javascript string into something that will generate that string.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#transform_string_fromCharCode-instance_method" title="#transform_string_fromCharCode (instance method)">- (Object) <strong>transform_string_fromCharCode</strong>(str) </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return a call to String.fromCharCode() with each char of the input as
arguments.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#transform_string_split_concat-instance_method" title="#transform_string_split_concat (instance method)">- (Object) <strong>transform_string_split_concat</strong>(str, quote) </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Split a javascript string, <code>str</code>, into multiple randomly-ordered
parts and return an anonymous javascript function that joins them in the
correct order.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Rex::Exploitation::JSObfu (class)">JSObfu</a></span></tt>) <strong>initialize</strong>(code) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Saves <code>code</code> for later obfuscation with #obfuscate</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


68
69
70
71
72
73
74
75
76
77
78</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 68</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_code'>code</span><span class='rparen'>)</span>
  <span class='ivar'>@code</span> <span class='op'>=</span> <span class='id identifier rubyid_code'>code</span>
  <span class='ivar'>@funcs</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='ivar'>@vars</span>  <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='ivar'>@debug</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@rand_gen</span> <span class='op'>=</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>RandomIdentifierGenerator</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span>
    <span class='symbol'>:max_length</span> <span class='op'>=&gt;</span> <span class='int'>15</span><span class='comma'>,</span>
    <span class='symbol'>:first_char_set</span> <span class='op'>=&gt;</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='op'>::</span><span class='const'>Alpha</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_$</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='symbol'>:char_set</span> <span class='op'>=&gt;</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='op'>::</span><span class='const'>AlphaNumeric</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_$</span><span class='tstring_end'>&quot;</span></span>
  <span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="ast-instance_method">
  
    - (<tt>Object</tt>) <strong>ast</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Abstract Syntax Tree generated by RKelly::Parser#parse</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


63
64
65</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 63</span>

<span class='kw'>def</span> <span class='id identifier rubyid_ast'>ast</span>
  <span class='ivar'>@ast</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="<<-instance_method">
  
    - (<tt>Object</tt>) <strong>&lt;&lt;</strong>(str) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Add <code>str</code> to the un-obfuscated code.</p>

<p>Calling this method after #obfuscate is undefined</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


85
86
87</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 85</span>

<span class='kw'>def</span> <span class='op'>&lt;&lt;</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='ivar'>@code</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_str'>str</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="escape_length-instance_method">
  
    - (<tt>Object</tt>) <strong>escape_length</strong>(str)  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Stolen from obfuscatejs.rb</p>

<p>Determines the length of an escape sequence</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 373</span>

<span class='kw'>def</span> <span class='id identifier rubyid_escape_length'>escape_length</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_esc_len'>esc_len</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\\</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>case</span> <span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span><span class='int'>1</span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>u</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span> <span class='id identifier rubyid_esc_len'>esc_len</span> <span class='op'>=</span> <span class='int'>6</span>     <span class='comment'># unicode \u1234
</span>    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>x</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span> <span class='id identifier rubyid_esc_len'>esc_len</span> <span class='op'>=</span> <span class='int'>4</span>     <span class='comment'># hex, \x41
</span>    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[0-7]</span><span class='regexp_end'>/</span></span>              <span class='comment'># octal, \123, \0
</span>      <span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span><span class='int'>3</span><span class='rbracket'>]</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>([0-7]{1,3})</span><span class='regexp_end'>/</span></span>
      <span class='kw'>if</span> <span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='lparen'>(</span><span class='int'>8</span><span class='rparen'>)</span> <span class='op'>&gt;</span> <span class='int'>255</span>
        <span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span><span class='int'>3</span><span class='rbracket'>]</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>([0-7]{1,2})</span><span class='regexp_end'>/</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_esc_len'>esc_len</span> <span class='op'>=</span> <span class='int'>1</span> <span class='op'>+</span> <span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
    <span class='kw'>else</span><span class='semicolon'>;</span> <span class='id identifier rubyid_esc_len'>esc_len</span> <span class='op'>=</span> <span class='int'>2</span>         <span class='comment'># \&quot; \n, etc.
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_esc_len'>esc_len</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="obfuscate-instance_method">
  
    - (<tt>Object</tt>) <strong>obfuscate</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Parse and obfuscate</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


120
121
122
123</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 120</span>

<span class='kw'>def</span> <span class='id identifier rubyid_obfuscate'>obfuscate</span>
  <span class='id identifier rubyid_parse'>parse</span>
  <span class='id identifier rubyid_obfuscate_r'>obfuscate_r</span><span class='lparen'>(</span><span class='ivar'>@ast</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="obfuscate_r-instance_method">
  
    - (<tt>Object</tt>) <strong>obfuscate_r</strong>(ast)  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Recursive method to obfuscate the given <code>ast</code>.</p>

<p><code>ast</code> should be the result of RKelly::Parser#parse</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 147</span>

<span class='kw'>def</span> <span class='id identifier rubyid_obfuscate_r'>obfuscate_r</span><span class='lparen'>(</span><span class='id identifier rubyid_ast'>ast</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ast'>ast</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_node'>node</span><span class='op'>|</span>
    <span class='comment'>#if node.respond_to? :value and node.value.kind_of? String and node.value =~ /bodyOnLoad/i
</span>    <span class='comment'>#	$stdout.puts(&quot;bodyOnLoad: #{node.class}: #{node.value}&quot;)
</span>    <span class='comment'>#end
</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_node'>node</span>
    <span class='kw'>when</span> <span class='kw'>nil</span>
      <span class='kw'>nil</span>

    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>SourceElementsNode</span>
      <span class='comment'># Recurse
</span>      <span class='id identifier rubyid_obfuscate_r'>obfuscate_r</span><span class='lparen'>(</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>

    <span class='comment'>#when ::RKelly::Nodes::ObjectLiteralNode
</span>      <span class='comment'># TODO
</span>      <span class='comment'>#$stdout.puts(node.methods - Object.new.methods)
</span>      <span class='comment'>#$stdout.puts(node.value.inspect)
</span>
    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>PropertyNode</span>
      <span class='comment'># Property names must be bare words or string literals NOT
</span>      <span class='comment'># expressions!  Can&#39;t use transform_string() here
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[a-zA-Z_][a-zA-Z0-9_]*$</span><span class='regexp_end'>/</span></span>
        <span class='id identifier rubyid_n'>n</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>C*</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
          <span class='kw'>case</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>3</span><span class='rparen'>)</span>
          <span class='kw'>when</span> <span class='int'>0</span><span class='semicolon'>;</span> <span class='id identifier rubyid_n'>n</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\\x%02x</span><span class='tstring_end'>&quot;</span></span><span class='op'>%</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
          <span class='kw'>when</span> <span class='int'>1</span><span class='semicolon'>;</span> <span class='id identifier rubyid_n'>n</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\\</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='int'>8</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
          <span class='kw'>when</span> <span class='int'>2</span><span class='semicolon'>;</span> <span class='id identifier rubyid_n'>n</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_c'>c</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>C</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
          <span class='kw'>end</span>
        <span class='rbrace'>}</span>
        <span class='id identifier rubyid_n'>n</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_instance_variable_set'>instance_variable_set</span><span class='lparen'>(</span><span class='symbol'>:@name</span><span class='comma'>,</span> <span class='id identifier rubyid_n'>n</span><span class='rparen'>)</span>
      <span class='kw'>end</span>

    <span class='comment'># Variables
</span>    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>VarDeclNode</span>
      <span class='kw'>if</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_random_var_name'>random_var_name</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>ParameterNode</span>
      <span class='kw'>if</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_random_var_name'>random_var_name</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>ResolveNode</span>
      <span class='comment'>#$stdout.puts(&quot;Resolve bodyOnload: #{@vars[node.value]}&quot;) if &quot;bodyOnLoad&quot; == node.value
</span>      <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>DotAccessorNode</span>
      <span class='kw'>case</span> <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
      <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>ResolveNode</span>
        <span class='kw'>if</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span>
        <span class='kw'>end</span>
      <span class='comment'>#else
</span>      <span class='comment'>#	$stderr.puts(&quot;Non-resolve node as target of dotaccessor: #{node.value.class}&quot;)
</span>      <span class='kw'>end</span>

    <span class='comment'># Functions
</span>    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>FunctionDeclNode</span>
      <span class='comment'>#$stdout.puts(&quot;FunctionDecl: #{node.value}&quot;)
</span>      <span class='comment'># Functions can also act as objects, so store them in the vars
</span>      <span class='comment'># and the functions list so we can replace them in both places
</span>      <span class='kw'>if</span> <span class='ivar'>@funcs</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='ivar'>@funcs</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
        <span class='ivar'>@funcs</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_random_var_name'>random_var_name</span>
        <span class='kw'>if</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
          <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@funcs</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='ivar'>@funcs</span><span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span>
      <span class='kw'>end</span>
    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>FunctionCallNode</span>
      <span class='comment'># The value of a FunctionCallNode is some sort of accessor node or a ResolveNode
</span>      <span class='comment'># so this is basically useless
</span>      <span class='comment'>#$stdout.puts(&quot;Function call: #{node.name} =&gt; #{@funcs[node.name]}&quot;)
</span>      <span class='comment'>#node.value = @funcs[node.value] if @funcs[node.value]
</span>
    <span class='comment'># Transformers
</span>    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>NumberNode</span>
      <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_transform_number'>transform_number</span><span class='lparen'>(</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
    <span class='kw'>when</span> <span class='op'>::</span><span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Nodes</span><span class='op'>::</span><span class='const'>StringNode</span>
      <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_transform_string'>transform_string</span><span class='lparen'>(</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='comment'>#$stderr.puts &quot;#{node.class}: #{node.value}&quot;
</span>      <span class='comment'>#$stderr.puts &quot;#{node.class}&quot;
</span>    <span class='kw'>end</span>

    <span class='comment'>#unless node.kind_of? ::RKelly::Nodes::SourceElementsNode
</span>    <span class='comment'>#	$stderr.puts &quot;#{node.class}: #{node.value}&quot;
</span>    <span class='comment'>#end
</span>  <span class='kw'>end</span>

  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="parse-instance_method">
  
    - (<tt>Object</tt>) <strong>parse</strong>  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generate an Abstract Syntax Tree (#ast) for later obfuscation</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


245
246
247
248</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 245</span>

<span class='kw'>def</span> <span class='id identifier rubyid_parse'>parse</span>
  <span class='id identifier rubyid_parser'>parser</span> <span class='op'>=</span> <span class='const'>RKelly</span><span class='op'>::</span><span class='const'>Parser</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@ast</span> <span class='op'>=</span> <span class='id identifier rubyid_parser'>parser</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='ivar'>@code</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="rand_base-instance_method">
  
    - (<tt>Object</tt>) <strong>rand_base</strong>(num)  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Convert a number to a random base (decimal, octal, or hexedecimal).</p>

<p>Given 10 as input, the possible return values are:</p>

<pre class="code ruby"><code class="ruby"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>10</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0xa</span><span class='tstring_end'>&quot;</span></span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>012</span><span class='tstring_end'>&quot;</span></span></code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


258
259
260
261
262
263
264</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 258</span>

<span class='kw'>def</span> <span class='id identifier rubyid_rand_base'>rand_base</span><span class='lparen'>(</span><span class='id identifier rubyid_num'>num</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>3</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='int'>0</span><span class='semicolon'>;</span> <span class='id identifier rubyid_num'>num</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>when</span> <span class='int'>1</span><span class='semicolon'>;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0%o</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_num'>num</span>
  <span class='kw'>when</span> <span class='int'>2</span><span class='semicolon'>;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0x%x</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_num'>num</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="random_string-instance_method">
  
    - (<tt>String</tt>) <strong>random_string</strong>  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a random string</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>a random string</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


138
139
140</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 138</span>

<span class='kw'>def</span> <span class='id identifier rubyid_random_string'>random_string</span>
  <span class='ivar'>@rand_gen</span><span class='period'>.</span><span class='id identifier rubyid_generate'>generate</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="random_var_name-instance_method">
  
    - (<tt>String</tt>) <strong>random_var_name</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a unique random var name that is not a reserved keyword</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>a unique random var name that is not a reserved keyword</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


126
127
128
129
130
131
132
133</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 126</span>

<span class='kw'>def</span> <span class='id identifier rubyid_random_var_name'>random_var_name</span>
  <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_text'>text</span> <span class='op'>=</span> <span class='id identifier rubyid_random_string'>random_string</span>
    <span class='kw'>unless</span> <span class='ivar'>@vars</span><span class='period'>.</span><span class='id identifier rubyid_has_value?'>has_value?</span><span class='lparen'>(</span><span class='id identifier rubyid_text'>text</span><span class='rparen'>)</span> <span class='kw'>or</span> <span class='const'>RESERVED_KEYWORDS</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_text'>text</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_text'>text</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="safe_split-instance_method">
  
    - (<tt>Object</tt>) <strong>safe_split</strong>(str, quote)  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Split a javascript string, <code>str</code>, without breaking escape
sequences.</p>

<p>The maximum length of each piece of the string is half the total length of
the string, ensuring we (almost) always split into at least two pieces. 
This won&#39;t always be true when given a string like “AAx41”, where
escape sequences artificially increase the total length (escape sequences
are considered a single character).</p>

<p>Returns an array of two-element arrays.  The zeroeth element is a randomly
generated variable name, the first is a piece of the string contained in
<tt>quote</tt>s.</p>

<p>See #escape_length</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 343</span>

<span class='kw'>def</span> <span class='id identifier rubyid_safe_split'>safe_split</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='comma'>,</span> <span class='id identifier rubyid_quote'>quote</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_parts'>parts</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_max_len'>max_len</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>/</span> <span class='int'>2</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_len'>len</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_e_len'>e_len</span> <span class='op'>=</span> <span class='id identifier rubyid_escape_length'>escape_length</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='id identifier rubyid_len'>len</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_e_len'>e_len</span> <span class='op'>=</span> <span class='int'>1</span> <span class='kw'>if</span> <span class='id identifier rubyid_e_len'>e_len</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_len'>len</span> <span class='op'>+=</span> <span class='id identifier rubyid_e_len'>e_len</span>
      <span class='comment'># if we&#39;ve reached the end of the string, bail
</span>      <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='id identifier rubyid_len'>len</span><span class='rbracket'>]</span>
      <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_len'>len</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_max_len'>max_len</span>
      <span class='comment'># randomize the length of each part
</span>      <span class='kw'>break</span> <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>4</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_part'>part</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_len'>len</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_var'>var</span> <span class='op'>=</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_rand_text_alpha'>rand_text_alpha</span><span class='lparen'>(</span><span class='int'>4</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_parts'>parts</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span> <span class='lbracket'>[</span> <span class='id identifier rubyid_var'>var</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_quote'>quote</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_part'>part</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_quote'>quote</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbracket'>]</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_parts'>parts</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="sym-instance_method">
  
    - (<tt>Object</tt>) <strong>sym</strong>(lookup) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return the obfuscated name of a symbol</p>

<p>You MUST call #obfuscate before this method!</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


106
107
108
109
110
111
112
113
114
115</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 106</span>

<span class='kw'>def</span> <span class='id identifier rubyid_sym'>sym</span><span class='lparen'>(</span><span class='id identifier rubyid_lookup'>lookup</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_lookup'>lookup</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_ret'>ret</span> <span class='op'>=</span> <span class='ivar'>@vars</span><span class='lbracket'>[</span><span class='id identifier rubyid_lookup'>lookup</span><span class='rbracket'>]</span>
  <span class='kw'>elsif</span> <span class='ivar'>@funcs</span><span class='lbracket'>[</span><span class='id identifier rubyid_lookup'>lookup</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_ret'>ret</span> <span class='op'>=</span> <span class='ivar'>@funcs</span><span class='lbracket'>[</span><span class='id identifier rubyid_lookup'>lookup</span><span class='rbracket'>]</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_ret'>ret</span> <span class='op'>=</span> <span class='id identifier rubyid_lookup'>lookup</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_ret'>ret</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="to_s-instance_method">
  
    - (<tt>Object</tt>) <strong>to_s</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return the (possibly obfuscated) code as a string.</p>

<p>If #obfuscate has not been called before this, returns the parsed,
unobfuscated code.  This can be useful for example to remove comments and
standardize spacing.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


96
97
98
99</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 96</span>

<span class='kw'>def</span> <span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_parse'>parse</span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='ivar'>@ast</span>
  <span class='ivar'>@ast</span><span class='period'>.</span><span class='id identifier rubyid_to_ecma'>to_ecma</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="transform_number-instance_method">
  
    - (<tt>Object</tt>) <strong>transform_number</strong>(num)  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return a mathematical expression that will evaluate to the given number
<code>num</code>.</p>

<p><code>num</code> can be a float or an int, but should never be negative.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 272</span>

<span class='kw'>def</span> <span class='id identifier rubyid_transform_number'>transform_number</span><span class='lparen'>(</span><span class='id identifier rubyid_num'>num</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_num'>num</span>
  <span class='kw'>when</span> <span class='const'>Fixnum</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_num'>num</span> <span class='op'>==</span> <span class='int'>0</span>
      <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>10</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='int'>1</span>
      <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(&#39;</span><span class='embexpr_beg'>#{</span><span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_rand_text_alpha'>rand_text_alpha</span><span class='lparen'>(</span><span class='id identifier rubyid_r'>r</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.length - </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_r'>r</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_num'>num</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>and</span> <span class='id identifier rubyid_num'>num</span> <span class='op'>&lt;</span> <span class='int'>10</span>
      <span class='comment'># use a random string.length for small numbers
</span>      <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='embexpr_beg'>#{</span><span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_rand_text_alpha'>rand_text_alpha</span><span class='lparen'>(</span><span class='id identifier rubyid_num'>num</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;.length</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_divisor'>divisor</span> <span class='op'>=</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='id identifier rubyid_num'>num</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='int'>1</span>
      <span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='id identifier rubyid_num'>num</span> <span class='op'>/</span> <span class='id identifier rubyid_divisor'>divisor</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
      <span class='id identifier rubyid_b'>b</span> <span class='op'>=</span> <span class='id identifier rubyid_num'>num</span> <span class='op'>-</span> <span class='lparen'>(</span><span class='id identifier rubyid_a'>a</span> <span class='op'>*</span> <span class='id identifier rubyid_divisor'>divisor</span><span class='rparen'>)</span>
      <span class='comment'># recurse half the time for a
</span>      <span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_transform_number'>transform_number</span><span class='lparen'>(</span><span class='id identifier rubyid_a'>a</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_rand_base'>rand_base</span><span class='lparen'>(</span><span class='id identifier rubyid_a'>a</span><span class='rparen'>)</span>
      <span class='comment'># recurse half the time for divisor
</span>      <span class='id identifier rubyid_divisor'>divisor</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_transform_number'>transform_number</span><span class='lparen'>(</span><span class='id identifier rubyid_divisor'>divisor</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_rand_base'>rand_base</span><span class='lparen'>(</span><span class='id identifier rubyid_divisor'>divisor</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_a'>a</span><span class='embexpr_end'>}</span><span class='tstring_content'>*</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_divisor'>divisor</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_b'>b</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'>Float</span>
    <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_num'>num</span> <span class='op'>-</span> <span class='id identifier rubyid_num'>num</span><span class='period'>.</span><span class='id identifier rubyid_floor'>floor</span><span class='embexpr_end'>}</span><span class='tstring_content'> + </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rand_base'>rand_base</span><span class='lparen'>(</span><span class='id identifier rubyid_num'>num</span><span class='period'>.</span><span class='id identifier rubyid_floor'>floor</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'>#puts(&quot;#{num} == #{transformed}&quot;)
</span>
  <span class='id identifier rubyid_transformed'>transformed</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="transform_string-instance_method">
  
    - (<tt>Object</tt>) <strong>transform_string</strong>(str)  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Convert a javascript string into something that will generate that string.</p>

<p>Randomly calls one of the <code>transform_string_*</code> methods</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 308</span>

<span class='kw'>def</span> <span class='id identifier rubyid_transform_string'>transform_string</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_quote'>quote</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rbracket'>]</span>
  <span class='comment'># pull off the quotes
</span>  <span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span><span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>2</span><span class='rbracket'>]</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_quote'>quote</span><span class='op'>*</span><span class='int'>2</span> <span class='kw'>if</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>0</span>

  <span class='kw'>case</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='int'>0</span>
    <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>=</span> <span class='id identifier rubyid_transform_string_split_concat'>transform_string_split_concat</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='comma'>,</span> <span class='id identifier rubyid_quote'>quote</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='int'>1</span>
    <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>=</span> <span class='id identifier rubyid_transform_string_fromCharCode'>transform_string_fromCharCode</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='comment'>#when 2
</span>  <span class='comment'>#	# Currently no-op
</span>  <span class='comment'>#	transformed = transform_string_unescape(str)
</span>  <span class='kw'>end</span>

  <span class='comment'>#$stderr.puts &quot;Obfuscating str: #{str.ljust 30} #{transformed}&quot;
</span>  <span class='id identifier rubyid_transformed'>transformed</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="transform_string_fromCharCode-instance_method">
  
    - (<tt>Object</tt>) <strong>transform_string_fromCharCode</strong>(str)  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return a call to String.fromCharCode() with each char of the input as
arguments</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby">input : &quot;A\n&quot;
output: String.fromCharCode(0x41, 10)</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 425</span>

<span class='kw'>def</span> <span class='id identifier rubyid_transform_string_fromCharCode'>transform_string_fromCharCode</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_buf'>buf</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>String.fromCharCode(</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_bytes'>bytes</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>C*</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_len'>len</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\\</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rparen'>)</span>
      <span class='comment'># then this is an escape sequence and we need to deal with all
</span>      <span class='comment'># the special cases
</span>      <span class='kw'>case</span> <span class='id identifier rubyid_str'>str</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rbracket'>]</span>
      <span class='comment'># For chars that contain their non-escaped selves, step past
</span>      <span class='comment'># the backslash and let the rand_base() below decide how to
</span>      <span class='comment'># represent the character.
</span>      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&quot;</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\\</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_char'>char</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>C</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='comment'># For symbolic escapes, use the known value
</span>      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>n</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>=</span> <span class='int'>0x0a</span><span class='semicolon'>;</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rparen'>)</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>t</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>=</span> <span class='int'>0x09</span><span class='semicolon'>;</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rparen'>)</span>
      <span class='comment'># Lastly, if it&#39;s a hex, unicode, or octal escape, pull out the
</span>      <span class='comment'># real value and use that
</span>      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>x</span><span class='tstring_end'>&quot;</span></span>
        <span class='comment'># Strip the x
</span>        <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_char'>char</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>2</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='int'>16</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>u</span><span class='tstring_end'>&quot;</span></span>
        <span class='comment'># This can potentially lose information in the case of
</span>        <span class='comment'># characters like \u0041, but since regular ascii is stored
</span>        <span class='comment'># as unicode internally, String.fromCharCode(0x41) will be
</span>        <span class='comment'># represented as 00 41 in memory anyway, so it shouldn&#39;t
</span>        <span class='comment'># matter.
</span>        <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_char'>char</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>4</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='int'>16</span>
      <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[0-7]</span><span class='regexp_end'>/</span></span>
        <span class='comment'># Octals are a bit harder since they are variable width and
</span>        <span class='comment'># don&#39;t necessarily mean what you might think. For example,
</span>        <span class='comment'># &quot;\61&quot; == &quot;1&quot; and &quot;\610&quot; == &quot;10&quot;.  610 is a valid octal
</span>        <span class='comment'># number, but not a valid ascii character.  Javascript will
</span>        <span class='comment'># interpreter as much as it can as a char and use the rest
</span>        <span class='comment'># as a literal.  Boo.
</span>        <span class='id identifier rubyid_str'>str</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>([0-7]{1,3})</span><span class='regexp_end'>/</span></span>
        <span class='id identifier rubyid_char'>char</span> <span class='op'>=</span> <span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='int'>8</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>&gt;</span> <span class='int'>255</span>
          <span class='id identifier rubyid_str'>str</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>([0-7]{1,2})</span><span class='regexp_end'>/</span></span>
          <span class='id identifier rubyid_char'>char</span> <span class='op'>=</span> <span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='int'>8</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_char'>char</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>C</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_buf'>buf</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rand_base'>rand_base</span><span class='lparen'>(</span><span class='id identifier rubyid_char'>char</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>,</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='comment'># Strip off the last comma
</span>  <span class='id identifier rubyid_buf'>buf</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span><span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_transformed'>transformed</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span>

  <span class='id identifier rubyid_transformed'>transformed</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="transform_string_split_concat-instance_method">
  
    - (<tt>Object</tt>) <strong>transform_string_split_concat</strong>(str, quote)  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Split a javascript string, <code>str</code>, into multiple randomly-ordered
parts and return an anonymous javascript function that joins them in the
correct order.  This method can be called safely on strings containing
escape sequences.  See #safe_split.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


397
398
399
400
401
402
403
404
405
406
407
408
409
410</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/jsobfu.rb', line 397</span>

<span class='kw'>def</span> <span class='id identifier rubyid_transform_string_split_concat'>transform_string_split_concat</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='comma'>,</span> <span class='id identifier rubyid_quote'>quote</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_parts'>parts</span> <span class='op'>=</span> <span class='id identifier rubyid_safe_split'>safe_split</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='comma'>,</span> <span class='id identifier rubyid_quote'>quote</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_func'>func</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(function () { var </span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_ret'>ret</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>; return </span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_parts'>parts</span><span class='period'>.</span><span class='id identifier rubyid_sort'>sort</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span><span class='id identifier rubyid_b'>b</span><span class='op'>|</span> <span class='id identifier rubyid_rand'>rand</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_part'>part</span><span class='op'>|</span>
    <span class='id identifier rubyid_func'>func</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>,</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_func'>func</span><span class='period'>.</span><span class='id identifier rubyid_chop!'>chop!</span>

  <span class='id identifier rubyid_ret'>ret</span>  <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_parts'>parts</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_part'>part</span><span class='op'>|</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_final'>final</span> <span class='op'>=</span> <span class='id identifier rubyid_func'>func</span> <span class='op'>+</span> <span class='id identifier rubyid_ret'>ret</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> })()</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_final'>final</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Wed Sep  3 01:52:03 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-2.1.2).
</div>

  </body>
</html>